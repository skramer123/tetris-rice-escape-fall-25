<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Tetris Fill with Music, Timer & Keypad</title>
<style>
    body {
        background: #111;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        color: white;
        font-family: Arial, sans-serif;
    }
    #gameContainer { position: relative; }

    #board {
        background: #222;
        image-rendering: pixelated;
        border: 4px solid #555;
        display: block;
    }

    #message {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.7);
        padding: 20px 40px;
        border-radius: 10px;
        font-size: 32px;
        text-align: center;
        display: none;
        pointer-events: none;
        z-index: 2;
    }

    #nextBox {
        position: absolute;
        top: 10px;
        right: -140px;
        width: 120px;
        height: 130px;
        border: 2px solid #666;
        background: #111;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        color: #bbb;
        font-size: 11px;
        padding: 4px;
        box-shadow: 0 0 10px rgba(0,0,0,0.6);
        z-index: 1;
    }
    #blocksRemaining {
        margin-top: 4px;
        font-size: 11px;
        color: #bbb;
        text-align: center;
    }

    /* Large timer on the left */
    #timer {
        position: absolute;
        left: -150px;
        top: 40px;
        font-size: 50px;
        font-weight: bold;
        color: #fff;
    }

    audio { display:none; }

    /* RESET BAR */
    #resetBarWrapper {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 70%;
        max-width: 260px;
        display: none;
        text-align: center;
        font-size: 14px;
        z-index: 3;
    }
    #resetBarBG {
        width: 100%;
        height: 10px;
        background: rgba(255,255,255,0.2);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    #resetBarFill {
        height: 100%;
        width: 0%;
        background: #4caf50;
        transition: width 0.1s linear;
    }

    /* RAISE TARGET BAR */
    #raiseBarWrapper {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        width: 70%;
        max-width: 260px;
        display: none;
        text-align: center;
        font-size: 14px;
        z-index: 3;
    }
    #raiseBarBG {
        width: 100%;
        height: 10px;
        background: rgba(255,255,255,0.2);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    #raiseBarFill {
        height: 100%;
        width: 0%;
        background: #ff9800;
        transition: width 0.1s linear;
    }

    /* ESCAPE + ALIEN OVERLAY */
    #fullOverlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: #000;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        color: #fff;
        text-align: center;
    }
    #fullOverlay img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #fullOverlayMessage {
        font-size: 48px;
        font-weight: bold;
    }

    /* ====== KEYPAD PANEL (SCALED 1.7×) ====== */
    #keypadPanel {
        position: absolute;
        left: -260px;
        top: 180px;
        width: calc(220px * 1.7);
        padding: calc(10px * 1.7);
        background: #111;
        border: 2px solid #555;
        border-radius: 10px;
        color: #fff;
        font-size: calc(14px * 1.7);
        display: none;
        box-shadow: 0 0 10px rgba(0,0,0,0.6);
        z-index: 10;
    }

    #keypadTitle {
        text-align: center;
        font-size: calc(14px * 1.7);
        margin-bottom: calc(6px * 1.7);
    }

    #keypadDigits {
        display: flex;
        justify-content: space-between;
        margin: calc(4px * 1.7) 0;
        font-size: calc(16px * 1.7);
    }

    .keypadDigit {
        padding: calc(4px * 1.7) calc(6px * 1.7);
        border-radius: calc(4px * 1.7);
    }

    .keypadDigit.selected {
        border: calc(1px * 1.7) solid #fff;
    }

    #keypadInput {
        margin-top: calc(8px * 1.7);
        font-size: calc(20px * 1.7);
        text-align: center;
        letter-spacing: calc(4px * 1.7);
    }

    #keypadHelp {
        margin-top: calc(6px * 1.7);
        font-size: calc(11px * 1.7);
        color: #bbb;
        text-align: center;
    }
</style>
</head>
<body>

<div id="gameContainer">
    <canvas id="board"></canvas>
    <div id="message"></div>

    <!-- Next Block Box -->
    <div id="nextBox">
        <div>Next</div>
        <canvas id="nextCanvas" width="80" height="60"></canvas>
        <div id="blocksRemaining">Blocks remaining: 23</div>
    </div>

    <!-- Timer -->
    <div id="timer">60:00</div>

    <!-- FULL OVERLAY -->
    <div id="fullOverlay">
        <div id="fullOverlayContent"></div>
    </div>

    <!-- Reset bar -->
    <div id="resetBarWrapper">
        <div id="resetBarBG"><div id="resetBarFill"></div></div>
        <div id="resetBarText">Hold R to reset</div>
    </div>

    <!-- Raise bar -->
    <div id="raiseBarWrapper">
        <div id="raiseBarBG"><div id="raiseBarFill"></div></div>
        <div>Hold H to raise target</div>
    </div>

    <!-- Escape bar -->
    <div id="escapeBarWrapper" style="display:none; position:absolute; bottom:70px; left:50%; transform:translateX(-50%); width:70%; max-width:260px; text-align:center; z-index:3; font-size:14px;">
        <div style="width:100%; height:10px; background:rgba(255,255,255,0.2); border-radius:5px; overflow:hidden; margin-bottom:4px;">
            <div id="escapeBarFill" style="height:100%; width:0%; background:#e91e63; transition:width 0.1s linear;"></div>
        </div>
        <div>Hold W to escape</div>
    </div>

    <!-- Pause bar -->
    <div id="pauseBarWrapper" style="display:none; position:absolute; bottom:95px; left:50%; transform:translateX(-50%); width:70%; max-width:260px; text-align:center; z-index:3; font-size:14px;">
        <div style="width:100%; height:10px; background:rgba(255,255,255,0.2); border-radius:5px; overflow:hidden; margin-bottom:4px;">
            <div id="pauseBarFill" style="height:100%; width:0%; background:#00bcd4; transition:width 0.1s linear;"></div>
        </div>
        <div>Hold P to pause/play timer</div>
    </div>

    <!-- KEYPAD PANEL -->
    <div id="keypadPanel">
        <div id="keypadTitle">Escape Pod Access Code</div>
        <div id="keypadDigits"></div>
        <div id="keypadInput">_ _ _ _</div>
        <div id="keypadHelp">←/→ move&nbsp;&nbsp; ↑ enter&nbsp;&nbsp; ↓ delete</div>
    </div>

</div>

<!-- Audio -->
<audio id="bgm" src="bg_music.mp3" loop></audio>
<audio id="escapeWinSound" src="escape_orchestra.mp3"></audio>
<audio id="winSound1" src="win_motor.mp3"></audio>
<audio id="winSound2" src="win_theme.mp3"></audio>
<audio id="alienSound" src="alien_scream.mp3"></audio>
<audio id="wrongCode" src="wrong-47985.mp3"></audio>

<script>
/* All variables, board setup, pieces, pieceOrder,
   game loop, overlays, reset logic, timers, etc.
   — identical to your working version —
   with keypad code inserted below.
*/

const COLS = 10, ROWS = 20, BLOCK = 30;
const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
const msgEl = document.getElementById("message");
const nextCanvas = document.getElementById("nextCanvas");
const nctx = nextCanvas.getContext("2d");
const bgm = document.getElementById("bgm");
const wrongCodeSound = document.getElementById("wrongCode");

canvas.width = COLS * BLOCK;
canvas.height = ROWS * BLOCK;

/* — YOUR EXISTING TETRIS CODE IS HERE —
   (unchanged to save space in this explanation)
   I’m inserting only the new keypad logic below.
*/

/* ========================
   KEYPAD LOGIC
   ======================== */

const keypadPanel = document.getElementById("keypadPanel");
const keypadDigitsEl = document.getElementById("keypadDigits");
const keypadInputEl = document.getElementById("keypadInput");

let keypadActive = false;
let keypadPos = 0;
let keypadDigits = ["0","1","2","3","4","5","6","7","8","9"];
let keypadEntered = [];

function showKeypad() {
    keypadActive = true;
    keypadPanel.style.display = "block";
    renderKeypad();
}

function hideKeypad() {
    keypadActive = false;
    keypadPanel.style.display = "none";
}

function renderKeypad() {
    keypadDigitsEl.innerHTML = "";
    keypadDigits.forEach((d,i)=>{
        const div = document.createElement("div");
        div.className = "keypadDigit" + (i===keypadPos ? " selected" : "");
        div.textContent = d;
        keypadDigitsEl.appendChild(div);
    });

    if(keypadEntered.length === 0){
        keypadInputEl.textContent = "_ _ _ _";
    } else {
        let out = keypadEntered.map(x=>x).join(" ");
        while(out.split(" ").length < 4){
            out += " _";
        }
        keypadInputEl.textContent = out;
    }
}

function keypadEnterDigit() {
    if(keypadEntered.length >= 4) return;
    keypadEntered.push(keypadDigits[keypadPos]);
    renderKeypad();

    if(keypadEntered.length === 4) checkKeypadCode();
}

function keypadBackspace() {
    keypadEntered.pop();
    renderKeypad();
}

function checkKeypadCode() {
    const code = keypadEntered.join("");
    if(code === "3256") {
        triggerEscapeOverlay();
    } else {
        wrongCodeSound.currentTime = 0;
        wrongCodeSound.play().catch(()=>{});
        keypadEntered = [];
        renderKeypad();
    }
}

/* ========================
   WIN EVENT — SHOW KEYPAD
   ======================== */

function showMessage(msg, autoRestart){
    msgEl.innerHTML = msg;
    msgEl.style.display = "block";

    if(msg.includes("You Win")) {
        // Do NOT auto restart — keypad required now
        setTimeout(()=>{ msgEl.style.display="none"; showKeypad(); }, 1000);
        return;
    }

    if(autoRestart){
        setTimeout(()=>{ lossResetGame(); }, 3000);
    }
}

/* ========================
   ARROW CONTROLS FOR KEYPAD
   ======================== */

document.addEventListener("keydown",(e)=>{
    if(!keypadActive) return;

    if(e.key === "ArrowLeft"){
        keypadPos = (keypadPos + keypadDigits.length - 1) % keypadDigits.length;
        renderKeypad();
    }
    if(e.key === "ArrowRight"){
        keypadPos = (keypadPos + 1) % keypadDigits.length;
        renderKeypad();
    }
    if(e.key === "ArrowUp"){
        keypadEnterDigit();
    }
    if(e.key === "ArrowDown"){
        keypadBackspace();
    }
});

/* ========================
   The rest of your game loop,
   timers, overlays, P/H/W bars,
   reset logic, etc. remains unchanged.
   ======================== */

</script>
</body>
</html>

